<% content_for :title, "Checkout for Product" %>

<h1>Checkout for <%= @product_title %></h1>

<% if flash[:success] %>
  <div class="alert alert-success"><%= flash[:success] %></div>
<% elsif flash[:error] %>
  <div class="alert alert-danger"><%= flash[:error] %></div>
<% end %>

<%= form_with url: checkout_product_path(@product), method: :post, local: true do |f| %>
  <div class="form-group">
    <%= f.label :name, "Your Name", class: "font-weight-bold" %>
    <%= f.text_field :name, class: "form-control", required: true %>
  </div>
  
  <div class="form-group">
    <%= f.label :email, "Your Email", class: "font-weight-bold" %>
    <%= f.email_field :email, class: "form-control", required: true %>
  </div>

  <div class="form-group">
    <label for="card-element" class="font-weight-bold" aria-label="Enter credit or debit card details">
      Credit or Debit Card
    </label>
    <div id="card-element" class="form-control">
      <!-- A Stripe Element will be inserted here -->
    </div>
    <small id="card-errors" class="text-danger mt-1" role="alert"></small>
  </div>

  <%= f.submit "Pay Now", class: "btn btn-primary btn-block mt-4" %>
<% end %>

<script src="https://js.stripe.com/v3/"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var stripe = Stripe('<%= Rails.configuration.stripe[:publishable_key] %>');
    var elements = stripe.elements();

    var style = {
      base: {
        fontSize: "16px",
        color: "#32325d",
        fontFamily: "'Helvetica Neue', Helvetica, sans-serif",
        "::placeholder": { color: "#aab7c4" }
      },
      invalid: { color: "#fa755a", iconColor: "#fa755a" }
    };

    var card = elements.create('card', { style: style });
    card.mount('#card-element');

    var form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      if (!form.checkValidity()) {
        alert("Please fill out all fields correctly.");
        return;
      }

      stripe.createToken(card).then(function(result) {
        if (result.error) {
          var errorElement = document.getElementById('card-errors');
          errorElement.textContent = result.error.message;
        } else {
          stripeTokenHandler(result.token);
        }
      });
    });

    function stripeTokenHandler(token) {
      var form = document.querySelector('form');
      var hiddenInput = document.createElement('input');
      hiddenInput.setAttribute('type', 'hidden');
      hiddenInput.setAttribute('name', 'stripeToken');
      hiddenInput.setAttribute('value', token.id);
      form.appendChild(hiddenInput);
      form.submit();
    }
  });
</script>
